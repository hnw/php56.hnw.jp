<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
<title>sslsock</title>
<meta name='robots' content='noindex,nofollow' />
<meta name='generator' content='GLOBAL-6.5.4' />
<meta http-equiv='Content-Style-Type' content='text/css' />
<link rel='stylesheet' type='text/css' href='../style.css' />
</head>
<body>
<pre>
<span class='curline'><a href='../S/867.html#L152'>sslsock</a>           152 ext/openssl/xp_ssl.c 	php_openssl_netstream_data_t *sslsock = (php_openssl_netstream_data_t*)stream-&gt;abstract;</span>
<span class='curline'><a href='../S/867.html#L153'>sslsock</a>           153 ext/openssl/xp_ssl.c 	int err = SSL_get_error(sslsock-&gt;ssl_handle, nr_bytes);</span>
<span class='curline'><a href='../S/867.html#L169'>sslsock</a>           169 ext/openssl/xp_ssl.c 			retry = is_init ? 1 : sslsock-&gt;s.is_blocked;</span>
<span class='curline'><a href='../S/867.html#L178'>sslsock</a>           178 ext/openssl/xp_ssl.c 					SSL_set_shutdown(sslsock-&gt;ssl_handle, SSL_SENT_SHUTDOWN|SSL_RECEIVED_SHUTDOWN);</span>
<span class='curline'><a href='../S/867.html#L461'>sslsock</a>           461 ext/openssl/xp_ssl.c 	php_openssl_netstream_data_t *sslsock = (php_openssl_netstream_data_t*)stream-&gt;abstract;</span>
<span class='curline'><a href='../S/867.html#L465'>sslsock</a>           465 ext/openssl/xp_ssl.c 		: sslsock-&gt;is_client;</span>
<span class='curline'><a href='../S/867.html#L470'>sslsock</a>           470 ext/openssl/xp_ssl.c 		: sslsock-&gt;is_client;</span>
<span class='curline'><a href='../S/867.html#L530'>sslsock</a>           530 ext/openssl/xp_ssl.c 		if (peer_name == NULL &amp;&amp; sslsock-&gt;is_client) {</span>
<span class='curline'><a href='../S/867.html#L531'>sslsock</a>           531 ext/openssl/xp_ssl.c 			peer_name = sslsock-&gt;url_name;</span>
<span class='curline'><a href='../S/867.html#L578'>sslsock</a>           578 ext/openssl/xp_ssl.c 	php_openssl_netstream_data_t *sslsock;</span>
<span class='curline'><a href='../S/867.html#L585'>sslsock</a>           585 ext/openssl/xp_ssl.c 	sslsock = (php_openssl_netstream_data_t*)stream-&gt;abstract;</span>
<span class='curline'><a href='../S/867.html#L703'>sslsock</a>           703 ext/openssl/xp_ssl.c 		ssl_policy_params.dwAuthType = (sslsock-&gt;is_client) ? AUTHTYPE_SERVER : AUTHTYPE_CLIENT;</span>
<span class='curline'><a href='../S/867.html#L820'>sslsock</a>           820 ext/openssl/xp_ssl.c 	php_openssl_netstream_data_t *sslsock = (php_openssl_netstream_data_t*)stream-&gt;abstract;</span>
<span class='curline'><a href='../S/867.html#L828'>sslsock</a>           828 ext/openssl/xp_ssl.c 	} else if (!sslsock-&gt;is_client) {</span>
<span class='curline'><a href='../S/867.html#L855'>sslsock</a>           855 ext/openssl/xp_ssl.c 		if (sslsock-&gt;is_client &amp;&amp; !SSL_CTX_set_default_verify_paths(ctx)) {</span>
<span class='curline'><a href='../S/867.html#L1015'>sslsock</a>          1015 ext/openssl/xp_ssl.c 	php_openssl_netstream_data_t *sslsock;</span>
<span class='curline'><a href='../S/867.html#L1020'>sslsock</a>          1020 ext/openssl/xp_ssl.c 	sslsock = (php_openssl_netstream_data_t*)stream-&gt;abstract;</span>
<span class='curline'><a href='../S/867.html#L1024'>sslsock</a>          1024 ext/openssl/xp_ssl.c 	if (sslsock-&gt;reneg-&gt;prev_handshake == 0) {</span>
<span class='curline'><a href='../S/867.html#L1025'>sslsock</a>          1025 ext/openssl/xp_ssl.c 		sslsock-&gt;reneg-&gt;prev_handshake = now.tv_sec;</span>
<span class='curline'><a href='../S/867.html#L1029'>sslsock</a>          1029 ext/openssl/xp_ssl.c 	elapsed_time = (now.tv_sec - sslsock-&gt;reneg-&gt;prev_handshake);</span>
<span class='curline'><a href='../S/867.html#L1030'>sslsock</a>          1030 ext/openssl/xp_ssl.c 	sslsock-&gt;reneg-&gt;prev_handshake = now.tv_sec;</span>
<span class='curline'><a href='../S/867.html#L1031'>sslsock</a>          1031 ext/openssl/xp_ssl.c 	sslsock-&gt;reneg-&gt;tokens -= (elapsed_time * (sslsock-&gt;reneg-&gt;limit / sslsock-&gt;reneg-&gt;window));</span>
<span class='curline'><a href='../S/867.html#L1033'>sslsock</a>          1033 ext/openssl/xp_ssl.c 	if (sslsock-&gt;reneg-&gt;tokens &lt; 0) {</span>
<span class='curline'><a href='../S/867.html#L1034'>sslsock</a>          1034 ext/openssl/xp_ssl.c 		sslsock-&gt;reneg-&gt;tokens = 0;</span>
<span class='curline'><a href='../S/867.html#L1036'>sslsock</a>          1036 ext/openssl/xp_ssl.c 	++sslsock-&gt;reneg-&gt;tokens;</span>
<span class='curline'><a href='../S/867.html#L1039'>sslsock</a>          1039 ext/openssl/xp_ssl.c 	if (sslsock-&gt;reneg-&gt;tokens &gt; sslsock-&gt;reneg-&gt;limit) {</span>
<span class='curline'><a href='../S/867.html#L1044'>sslsock</a>          1044 ext/openssl/xp_ssl.c 		sslsock-&gt;reneg-&gt;should_close = 1;</span>
<span class='curline'><a href='../S/867.html#L1064'>sslsock</a>          1064 ext/openssl/xp_ssl.c 				sslsock-&gt;reneg-&gt;should_close = 0;</span>
<span class='curline'><a href='../S/867.html#L1088'>sslsock</a>          1088 ext/openssl/xp_ssl.c static void init_server_reneg_limit(php_stream *stream, php_openssl_netstream_data_t *sslsock) /* {{{ */</span>
<span class='curline'><a href='../S/867.html#L1115'>sslsock</a>          1115 ext/openssl/xp_ssl.c 	sslsock-&gt;reneg = (void*)pemalloc(sizeof(php_openssl_handshake_bucket_t),</span>
<span class='curline'><a href='../S/867.html#L1119'>sslsock</a>          1119 ext/openssl/xp_ssl.c 	sslsock-&gt;reneg-&gt;limit = limit;</span>
<span class='curline'><a href='../S/867.html#L1120'>sslsock</a>          1120 ext/openssl/xp_ssl.c 	sslsock-&gt;reneg-&gt;window = window;</span>
<span class='curline'><a href='../S/867.html#L1121'>sslsock</a>          1121 ext/openssl/xp_ssl.c 	sslsock-&gt;reneg-&gt;prev_handshake = 0;</span>
<span class='curline'><a href='../S/867.html#L1122'>sslsock</a>          1122 ext/openssl/xp_ssl.c 	sslsock-&gt;reneg-&gt;tokens = 0;</span>
<span class='curline'><a href='../S/867.html#L1123'>sslsock</a>          1123 ext/openssl/xp_ssl.c 	sslsock-&gt;reneg-&gt;should_close = 0;</span>
<span class='curline'><a href='../S/867.html#L1125'>sslsock</a>          1125 ext/openssl/xp_ssl.c 	SSL_set_info_callback(sslsock-&gt;ssl_handle, info_callback);</span>
<span class='curline'><a href='../S/867.html#L1289'>sslsock</a>          1289 ext/openssl/xp_ssl.c 	php_openssl_netstream_data_t *sslsock;</span>
<span class='curline'><a href='../S/867.html#L1300'>sslsock</a>          1300 ext/openssl/xp_ssl.c 	sslsock = (php_openssl_netstream_data_t*)stream-&gt;abstract;</span>
<span class='curline'><a href='../S/867.html#L1302'>sslsock</a>          1302 ext/openssl/xp_ssl.c 	if (!(sslsock-&gt;sni_cert_count &amp;&amp; sslsock-&gt;sni_certs)) {</span>
<span class='curline'><a href='../S/867.html#L1306'>sslsock</a>          1306 ext/openssl/xp_ssl.c 	for (i=0; i &lt; sslsock-&gt;sni_cert_count; i++) {</span>
<span class='curline'><a href='../S/867.html#L1307'>sslsock</a>          1307 ext/openssl/xp_ssl.c 		if (matches_wildcard_name(server_name, sslsock-&gt;sni_certs[i].name)) {</span>
<span class='curline'><a href='../S/867.html#L1308'>sslsock</a>          1308 ext/openssl/xp_ssl.c 			SSL_set_SSL_CTX(ssl_handle, sslsock-&gt;sni_certs[i].ctx);</span>
<span class='curline'><a href='../S/867.html#L1317'>sslsock</a>          1317 ext/openssl/xp_ssl.c static int enable_server_sni(php_stream *stream, php_openssl_netstream_data_t *sslsock TSRMLS_DC)</span>
<span class='curline'><a href='../S/867.html#L1347'>sslsock</a>          1347 ext/openssl/xp_ssl.c 	sslsock-&gt;sni_cert_count = zend_hash_num_elements(Z_ARRVAL_PP(val));</span>
<span class='curline'><a href='../S/867.html#L1348'>sslsock</a>          1348 ext/openssl/xp_ssl.c 	if (sslsock-&gt;sni_cert_count == 0) {</span>
<span class='curline'><a href='../S/867.html#L1355'>sslsock</a>          1355 ext/openssl/xp_ssl.c 	sslsock-&gt;sni_certs = (php_openssl_sni_cert_t*)safe_pemalloc(sslsock-&gt;sni_cert_count,</span>
<span class='curline'><a href='../S/867.html#L1393'>sslsock</a>          1393 ext/openssl/xp_ssl.c 				sslsock-&gt;sni_certs[i].name = pestrdup(key, php_stream_is_persistent(stream));</span>
<span class='curline'><a href='../S/867.html#L1394'>sslsock</a>          1394 ext/openssl/xp_ssl.c 				sslsock-&gt;sni_certs[i].ctx = ctx;</span>
<span class='curline'><a href='../S/867.html#L1406'>sslsock</a>          1406 ext/openssl/xp_ssl.c 	SSL_CTX_set_tlsext_servername_callback(sslsock-&gt;ctx, server_sni_callback);</span>
<span class='curline'><a href='../S/867.html#L1411'>sslsock</a>          1411 ext/openssl/xp_ssl.c static void enable_client_sni(php_stream *stream, php_openssl_netstream_data_t *sslsock) /* {{{ */</span>
<span class='curline'><a href='../S/867.html#L1421'>sslsock</a>          1421 ext/openssl/xp_ssl.c 	sni_server_name = sslsock-&gt;url_name;</span>
<span class='curline'><a href='../S/867.html#L1431'>sslsock</a>          1431 ext/openssl/xp_ssl.c 		SSL_set_tlsext_host_name(sslsock-&gt;ssl_handle, sni_server_name);</span>
<span class='curline'><a href='../S/867.html#L1438'>sslsock</a>          1438 ext/openssl/xp_ssl.c 		php_openssl_netstream_data_t *sslsock,</span>
<span class='curline'><a href='../S/867.html#L1448'>sslsock</a>          1448 ext/openssl/xp_ssl.c 	if (sslsock-&gt;ssl_handle) {</span>
<span class='curline'><a href='../S/867.html#L1449'>sslsock</a>          1449 ext/openssl/xp_ssl.c 		if (sslsock-&gt;s.is_blocked) {</span>
<span class='curline'><a href='../S/867.html#L1461'>sslsock</a>          1461 ext/openssl/xp_ssl.c 	sslsock-&gt;is_client = cparam-&gt;inputs.method &amp; STREAM_CRYPTO_IS_CLIENT;</span>
<span class='curline'><a href='../S/867.html#L1467'>sslsock</a>          1467 ext/openssl/xp_ssl.c 		method = php_select_crypto_method(method_flags, sslsock-&gt;is_client TSRMLS_CC);</span>
<span class='curline'><a href='../S/867.html#L1472'>sslsock</a>          1472 ext/openssl/xp_ssl.c 		method = sslsock-&gt;is_client ? SSLv23_client_method() : SSLv23_server_method();</span>
<span class='curline'><a href='../S/867.html#L1480'>sslsock</a>          1480 ext/openssl/xp_ssl.c 	sslsock-&gt;ctx = SSL_CTX_new(method);</span>
<span class='curline'><a href='../S/867.html#L1483'>sslsock</a>          1483 ext/openssl/xp_ssl.c 	sslsock-&gt;ctx = SSL_CTX_new((SSL_METHOD*)method);</span>
<span class='curline'><a href='../S/867.html#L1486'>sslsock</a>          1486 ext/openssl/xp_ssl.c 	if (sslsock-&gt;ctx == NULL) {</span>
<span class='curline'><a href='../S/867.html#L1508'>sslsock</a>          1508 ext/openssl/xp_ssl.c 		disable_peer_verification(sslsock-&gt;ctx, stream TSRMLS_CC);</span>
<span class='curline'><a href='../S/867.html#L1509'>sslsock</a>          1509 ext/openssl/xp_ssl.c 	} else if (FAILURE == enable_peer_verification(sslsock-&gt;ctx, stream TSRMLS_CC)) {</span>
<span class='curline'><a href='../S/867.html#L1515'>sslsock</a>          1515 ext/openssl/xp_ssl.c 		SSL_CTX_set_default_passwd_cb_userdata(sslsock-&gt;ctx, stream);</span>
<span class='curline'><a href='../S/867.html#L1516'>sslsock</a>          1516 ext/openssl/xp_ssl.c 		SSL_CTX_set_default_passwd_cb(sslsock-&gt;ctx, passwd_callback);</span>
<span class='curline'><a href='../S/867.html#L1526'>sslsock</a>          1526 ext/openssl/xp_ssl.c 		if (SSL_CTX_set_cipher_list(sslsock-&gt;ctx, cipherlist) != 1) {</span>
<span class='curline'><a href='../S/867.html#L1530'>sslsock</a>          1530 ext/openssl/xp_ssl.c 	if (FAILURE == set_local_cert(sslsock-&gt;ctx, stream TSRMLS_CC)) {</span>
<span class='curline'><a href='../S/867.html#L1534'>sslsock</a>          1534 ext/openssl/xp_ssl.c 	SSL_CTX_set_options(sslsock-&gt;ctx, ssl_ctx_options);</span>
<span class='curline'><a href='../S/867.html#L1536'>sslsock</a>          1536 ext/openssl/xp_ssl.c 	if (sslsock-&gt;is_client == 0 &amp;&amp;</span>
<span class='curline'><a href='../S/867.html#L1538'>sslsock</a>          1538 ext/openssl/xp_ssl.c 		FAILURE == set_server_specific_opts(stream, sslsock-&gt;ctx TSRMLS_CC)</span>
<span class='curline'><a href='../S/867.html#L1543'>sslsock</a>          1543 ext/openssl/xp_ssl.c 	sslsock-&gt;ssl_handle = SSL_new(sslsock-&gt;ctx);</span>
<span class='curline'><a href='../S/867.html#L1544'>sslsock</a>          1544 ext/openssl/xp_ssl.c 	if (sslsock-&gt;ssl_handle == NULL) {</span>
<span class='curline'><a href='../S/867.html#L1546'>sslsock</a>          1546 ext/openssl/xp_ssl.c 		SSL_CTX_free(sslsock-&gt;ctx);</span>
<span class='curline'><a href='../S/867.html#L1547'>sslsock</a>          1547 ext/openssl/xp_ssl.c 		sslsock-&gt;ctx = NULL;</span>
<span class='curline'><a href='../S/867.html#L1550'>sslsock</a>          1550 ext/openssl/xp_ssl.c 		SSL_set_ex_data(sslsock-&gt;ssl_handle, php_openssl_get_ssl_stream_data_index(), stream);</span>
<span class='curline'><a href='../S/867.html#L1553'>sslsock</a>          1553 ext/openssl/xp_ssl.c 	if (!SSL_set_fd(sslsock-&gt;ssl_handle, sslsock-&gt;s.socket)) {</span>
<span class='curline'><a href='../S/867.html#L1559'>sslsock</a>          1559 ext/openssl/xp_ssl.c 	if (sslsock-&gt;is_client == 0 &amp;&amp; enable_server_sni(stream, sslsock TSRMLS_CC) == FAILURE) {</span>
<span class='curline'><a href='../S/867.html#L1565'>sslsock</a>          1565 ext/openssl/xp_ssl.c 	if (sslsock-&gt;is_client == 0) {</span>
<span class='curline'><a href='../S/867.html#L1566'>sslsock</a>          1566 ext/openssl/xp_ssl.c 		init_server_reneg_limit(stream, sslsock);</span>
<span class='curline'><a href='../S/867.html#L1571'>sslsock</a>          1571 ext/openssl/xp_ssl.c 		long mode = SSL_get_mode(sslsock-&gt;ssl_handle);</span>
<span class='curline'><a href='../S/867.html#L1572'>sslsock</a>          1572 ext/openssl/xp_ssl.c 		SSL_set_mode(sslsock-&gt;ssl_handle, mode | SSL_MODE_RELEASE_BUFFERS);</span>
<span class='curline'><a href='../S/867.html#L1582'>sslsock</a>          1582 ext/openssl/xp_ssl.c 			SSL_copy_session_id(sslsock-&gt;ssl_handle, ((php_openssl_netstream_data_t*)cparam-&gt;inputs.session-&gt;abstract)-&gt;ssl_handle);</span>
<span class='curline'><a href='../S/867.html#L1619'>sslsock</a>          1619 ext/openssl/xp_ssl.c static int capture_peer_certs(php_stream *stream, php_openssl_netstream_data_t *sslsock, X509 *peer_cert TSRMLS_DC) /* {{{ */</span>
<span class='curline'><a href='../S/867.html#L1643'>sslsock</a>          1643 ext/openssl/xp_ssl.c 		chain = SSL_get_peer_cert_chain(sslsock-&gt;ssl_handle);</span>
<span class='curline'><a href='../S/867.html#L1670'>sslsock</a>          1670 ext/openssl/xp_ssl.c 		php_openssl_netstream_data_t *sslsock,</span>
<span class='curline'><a href='../S/867.html#L1679'>sslsock</a>          1679 ext/openssl/xp_ssl.c 	if (cparam-&gt;inputs.activate &amp;&amp; !sslsock-&gt;ssl_active) {</span>
<span class='curline'><a href='../S/867.html#L1682'>sslsock</a>          1682 ext/openssl/xp_ssl.c 		int				blocked		= sslsock-&gt;s.is_blocked,</span>
<span class='curline'><a href='../S/867.html#L1686'>sslsock</a>          1686 ext/openssl/xp_ssl.c 		if (sslsock-&gt;is_client) {</span>
<span class='curline'><a href='../S/867.html#L1687'>sslsock</a>          1687 ext/openssl/xp_ssl.c 			enable_client_sni(stream, sslsock);</span>
<span class='curline'><a href='../S/867.html#L1691'>sslsock</a>          1691 ext/openssl/xp_ssl.c 		if (!sslsock-&gt;state_set) {</span>
<span class='curline'><a href='../S/867.html#L1692'>sslsock</a>          1692 ext/openssl/xp_ssl.c 			if (sslsock-&gt;is_client) {</span>
<span class='curline'><a href='../S/867.html#L1693'>sslsock</a>          1693 ext/openssl/xp_ssl.c 				SSL_set_connect_state(sslsock-&gt;ssl_handle);</span>
<span class='curline'><a href='../S/867.html#L1695'>sslsock</a>          1695 ext/openssl/xp_ssl.c 				SSL_set_accept_state(sslsock-&gt;ssl_handle);</span>
<span class='curline'><a href='../S/867.html#L1697'>sslsock</a>          1697 ext/openssl/xp_ssl.c 			sslsock-&gt;state_set = 1;</span>
<span class='curline'><a href='../S/867.html#L1700'>sslsock</a>          1700 ext/openssl/xp_ssl.c 		if (SUCCESS == php_set_sock_blocking(sslsock-&gt;s.socket, 0 TSRMLS_CC)) {</span>
<span class='curline'><a href='../S/867.html#L1701'>sslsock</a>          1701 ext/openssl/xp_ssl.c 			sslsock-&gt;s.is_blocked = 0;</span>
<span class='curline'><a href='../S/867.html#L1704'>sslsock</a>          1704 ext/openssl/xp_ssl.c 		timeout = sslsock-&gt;is_client ? &amp;sslsock-&gt;connect_timeout : &amp;sslsock-&gt;s.timeout;</span>
<span class='curline'><a href='../S/867.html#L1705'>sslsock</a>          1705 ext/openssl/xp_ssl.c 		has_timeout = !sslsock-&gt;s.is_blocked &amp;&amp; (timeout-&gt;tv_sec || timeout-&gt;tv_usec);</span>
<span class='curline'><a href='../S/867.html#L1715'>sslsock</a>          1715 ext/openssl/xp_ssl.c 			if (sslsock-&gt;is_client) {</span>
<span class='curline'><a href='../S/867.html#L1716'>sslsock</a>          1716 ext/openssl/xp_ssl.c 				n = SSL_connect(sslsock-&gt;ssl_handle);</span>
<span class='curline'><a href='../S/867.html#L1718'>sslsock</a>          1718 ext/openssl/xp_ssl.c 				n = SSL_accept(sslsock-&gt;ssl_handle);</span>
<span class='curline'><a href='../S/867.html#L1737'>sslsock</a>          1737 ext/openssl/xp_ssl.c 					int err = SSL_get_error(sslsock-&gt;ssl_handle, n);</span>
<span class='curline'><a href='../S/867.html#L1743'>sslsock</a>          1743 ext/openssl/xp_ssl.c 					php_pollfd_for(sslsock-&gt;s.socket, (err == SSL_ERROR_WANT_READ) ?</span>
<span class='curline'><a href='../S/867.html#L1751'>sslsock</a>          1751 ext/openssl/xp_ssl.c 		if (sslsock-&gt;s.is_blocked != blocked &amp;&amp; SUCCESS == php_set_sock_blocking(sslsock-&gt;s.socket, blocked TSRMLS_CC)) {</span>
<span class='curline'><a href='../S/867.html#L1752'>sslsock</a>          1752 ext/openssl/xp_ssl.c 			sslsock-&gt;s.is_blocked = blocked;</span>
<span class='curline'><a href='../S/867.html#L1756'>sslsock</a>          1756 ext/openssl/xp_ssl.c 			peer_cert = SSL_get_peer_certificate(sslsock-&gt;ssl_handle);</span>
<span class='curline'><a href='../S/867.html#L1758'>sslsock</a>          1758 ext/openssl/xp_ssl.c 				cert_captured = capture_peer_certs(stream, sslsock, peer_cert TSRMLS_CC);</span>
<span class='curline'><a href='../S/867.html#L1761'>sslsock</a>          1761 ext/openssl/xp_ssl.c 			if (FAILURE == apply_peer_verification_policy(sslsock-&gt;ssl_handle, peer_cert, stream TSRMLS_CC)) {</span>
<span class='curline'><a href='../S/867.html#L1762'>sslsock</a>          1762 ext/openssl/xp_ssl.c 				SSL_shutdown(sslsock-&gt;ssl_handle);</span>
<span class='curline'><a href='../S/867.html#L1765'>sslsock</a>          1765 ext/openssl/xp_ssl.c 				sslsock-&gt;ssl_active = 1;</span>
<span class='curline'><a href='../S/867.html#L1774'>sslsock</a>          1774 ext/openssl/xp_ssl.c 						zval *meta_arr = capture_session_meta(sslsock-&gt;ssl_handle);</span>
<span class='curline'><a href='../S/867.html#L1785'>sslsock</a>          1785 ext/openssl/xp_ssl.c 			peer_cert = SSL_get_peer_certificate(sslsock-&gt;ssl_handle);</span>
<span class='curline'><a href='../S/867.html#L1787'>sslsock</a>          1787 ext/openssl/xp_ssl.c 				cert_captured = capture_peer_certs(stream, sslsock, peer_cert TSRMLS_CC);</span>
<span class='curline'><a href='../S/867.html#L1797'>sslsock</a>          1797 ext/openssl/xp_ssl.c 	} else if (!cparam-&gt;inputs.activate &amp;&amp; sslsock-&gt;ssl_active) {</span>
<span class='curline'><a href='../S/867.html#L1799'>sslsock</a>          1799 ext/openssl/xp_ssl.c 		SSL_shutdown(sslsock-&gt;ssl_handle);</span>
<span class='curline'><a href='../S/867.html#L1800'>sslsock</a>          1800 ext/openssl/xp_ssl.c 		sslsock-&gt;ssl_active = 0;</span>
<span class='curline'><a href='../S/867.html#L1827'>sslsock</a>          1827 ext/openssl/xp_ssl.c 	php_openssl_netstream_data_t *sslsock = (php_openssl_netstream_data_t*)stream-&gt;abstract;</span>
<span class='curline'><a href='../S/867.html#L1831'>sslsock</a>          1831 ext/openssl/xp_ssl.c 	if (sslsock-&gt;ssl_active) {</span>
<span class='curline'><a href='../S/867.html#L1835'>sslsock</a>          1835 ext/openssl/xp_ssl.c 		int began_blocked = sslsock-&gt;s.is_blocked;</span>
<span class='curline'><a href='../S/867.html#L1839'>sslsock</a>          1839 ext/openssl/xp_ssl.c 		if (began_blocked &amp;&amp; &amp;sslsock-&gt;s.timeout) {</span>
<span class='curline'><a href='../S/867.html#L1840'>sslsock</a>          1840 ext/openssl/xp_ssl.c 			timeout = &amp;sslsock-&gt;s.timeout;</span>
<span class='curline'><a href='../S/867.html#L1843'>sslsock</a>          1843 ext/openssl/xp_ssl.c 		if (timeout &amp;&amp; php_set_sock_blocking(sslsock-&gt;s.socket, 0 TSRMLS_CC) == SUCCESS) {</span>
<span class='curline'><a href='../S/867.html#L1844'>sslsock</a>          1844 ext/openssl/xp_ssl.c 			sslsock-&gt;s.is_blocked = 0;</span>
<span class='curline'><a href='../S/867.html#L1847'>sslsock</a>          1847 ext/openssl/xp_ssl.c 		if (!sslsock-&gt;s.is_blocked &amp;&amp; timeout &amp;&amp; (timeout-&gt;tv_sec || timeout-&gt;tv_usec)) {</span>
<span class='curline'><a href='../S/867.html#L1868'>sslsock</a>          1868 ext/openssl/xp_ssl.c 						php_set_sock_blocking(sslsock-&gt;s.socket, 1 TSRMLS_CC);</span>
<span class='curline'><a href='../S/867.html#L1869'>sslsock</a>          1869 ext/openssl/xp_ssl.c 						sslsock-&gt;s.is_blocked = 1;</span>
<span class='curline'><a href='../S/867.html#L1871'>sslsock</a>          1871 ext/openssl/xp_ssl.c 					sslsock-&gt;s.timeout_event = 1;</span>
<span class='curline'><a href='../S/867.html#L1878'>sslsock</a>          1878 ext/openssl/xp_ssl.c 				nr_bytes = SSL_read(sslsock-&gt;ssl_handle, buf, count);</span>
<span class='curline'><a href='../S/867.html#L1880'>sslsock</a>          1880 ext/openssl/xp_ssl.c 				if (sslsock-&gt;reneg &amp;&amp; sslsock-&gt;reneg-&gt;should_close) {</span>
<span class='curline'><a href='../S/867.html#L1888'>sslsock</a>          1888 ext/openssl/xp_ssl.c 				nr_bytes = SSL_write(sslsock-&gt;ssl_handle, buf, count);</span>
<span class='curline'><a href='../S/867.html#L1900'>sslsock</a>          1900 ext/openssl/xp_ssl.c 				int err = SSL_get_error(sslsock-&gt;ssl_handle, nr_bytes );</span>
<span class='curline'><a href='../S/867.html#L1913'>sslsock</a>          1913 ext/openssl/xp_ssl.c 					stream-&gt;eof = (retry == 0 &amp;&amp; errno != EAGAIN &amp;&amp; !SSL_pending(sslsock-&gt;ssl_handle));</span>
<span class='curline'><a href='../S/867.html#L1926'>sslsock</a>          1926 ext/openssl/xp_ssl.c 						php_pollfd_for(sslsock-&gt;s.socket, (err == SSL_ERROR_WANT_WRITE) ?</span>
<span class='curline'><a href='../S/867.html#L1929'>sslsock</a>          1929 ext/openssl/xp_ssl.c 						php_pollfd_for(sslsock-&gt;s.socket, (err == SSL_ERROR_WANT_READ) ?</span>
<span class='curline'><a href='../S/867.html#L1935'>sslsock</a>          1935 ext/openssl/xp_ssl.c 				int err = SSL_get_error(sslsock-&gt;ssl_handle, nr_bytes);</span>
<span class='curline'><a href='../S/867.html#L1944'>sslsock</a>          1944 ext/openssl/xp_ssl.c 						php_pollfd_for(sslsock-&gt;s.socket, (err == SSL_ERROR_WANT_WRITE) ?</span>
<span class='curline'><a href='../S/867.html#L1947'>sslsock</a>          1947 ext/openssl/xp_ssl.c 						php_pollfd_for(sslsock-&gt;s.socket, (err == SSL_ERROR_WANT_READ) ?</span>
<span class='curline'><a href='../S/867.html#L1961'>sslsock</a>          1961 ext/openssl/xp_ssl.c 		if (began_blocked &amp;&amp; php_set_sock_blocking(sslsock-&gt;s.socket, 1 TSRMLS_CC) == SUCCESS) {</span>
<span class='curline'><a href='../S/867.html#L1962'>sslsock</a>          1962 ext/openssl/xp_ssl.c 			sslsock-&gt;s.is_blocked = 1;</span>
<span class='curline'><a href='../S/867.html#L2012'>sslsock</a>          2012 ext/openssl/xp_ssl.c 	php_openssl_netstream_data_t *sslsock = (php_openssl_netstream_data_t*)stream-&gt;abstract;</span>
<span class='curline'><a href='../S/867.html#L2019'>sslsock</a>          2019 ext/openssl/xp_ssl.c 		if (sslsock-&gt;ssl_active) {</span>
<span class='curline'><a href='../S/867.html#L2020'>sslsock</a>          2020 ext/openssl/xp_ssl.c 			SSL_shutdown(sslsock-&gt;ssl_handle);</span>
<span class='curline'><a href='../S/867.html#L2021'>sslsock</a>          2021 ext/openssl/xp_ssl.c 			sslsock-&gt;ssl_active = 0;</span>
<span class='curline'><a href='../S/867.html#L2023'>sslsock</a>          2023 ext/openssl/xp_ssl.c 		if (sslsock-&gt;ssl_handle) {</span>
<span class='curline'><a href='../S/867.html#L2024'>sslsock</a>          2024 ext/openssl/xp_ssl.c 			SSL_free(sslsock-&gt;ssl_handle);</span>
<span class='curline'><a href='../S/867.html#L2025'>sslsock</a>          2025 ext/openssl/xp_ssl.c 			sslsock-&gt;ssl_handle = NULL;</span>
<span class='curline'><a href='../S/867.html#L2027'>sslsock</a>          2027 ext/openssl/xp_ssl.c 		if (sslsock-&gt;ctx) {</span>
<span class='curline'><a href='../S/867.html#L2028'>sslsock</a>          2028 ext/openssl/xp_ssl.c 			SSL_CTX_free(sslsock-&gt;ctx);</span>
<span class='curline'><a href='../S/867.html#L2029'>sslsock</a>          2029 ext/openssl/xp_ssl.c 			sslsock-&gt;ctx = NULL;</span>
<span class='curline'><a href='../S/867.html#L2032'>sslsock</a>          2032 ext/openssl/xp_ssl.c 		if (sslsock-&gt;s.socket == -1)</span>
<span class='curline'><a href='../S/867.html#L2033'>sslsock</a>          2033 ext/openssl/xp_ssl.c 			sslsock-&gt;s.socket = SOCK_ERR;</span>
<span class='curline'><a href='../S/867.html#L2035'>sslsock</a>          2035 ext/openssl/xp_ssl.c 		if (sslsock-&gt;s.socket != SOCK_ERR) {</span>
<span class='curline'><a href='../S/867.html#L2038'>sslsock</a>          2038 ext/openssl/xp_ssl.c 			shutdown(sslsock-&gt;s.socket, SHUT_RD);</span>
<span class='curline'><a href='../S/867.html#L2047'>sslsock</a>          2047 ext/openssl/xp_ssl.c 				n = php_pollfd_for_ms(sslsock-&gt;s.socket, POLLOUT, 500);</span>
<span class='curline'><a href='../S/867.html#L2050'>sslsock</a>          2050 ext/openssl/xp_ssl.c 			closesocket(sslsock-&gt;s.socket);</span>
<span class='curline'><a href='../S/867.html#L2051'>sslsock</a>          2051 ext/openssl/xp_ssl.c 			sslsock-&gt;s.socket = SOCK_ERR;</span>
<span class='curline'><a href='../S/867.html#L2055'>sslsock</a>          2055 ext/openssl/xp_ssl.c 	if (sslsock-&gt;sni_certs) {</span>
<span class='curline'><a href='../S/867.html#L2056'>sslsock</a>          2056 ext/openssl/xp_ssl.c 		for (i=0; i&lt;sslsock-&gt;sni_cert_count; i++) {</span>
<span class='curline'><a href='../S/867.html#L2057'>sslsock</a>          2057 ext/openssl/xp_ssl.c 			SSL_CTX_free(sslsock-&gt;sni_certs[i].ctx);</span>
<span class='curline'><a href='../S/867.html#L2058'>sslsock</a>          2058 ext/openssl/xp_ssl.c 			pefree(sslsock-&gt;sni_certs[i].name, php_stream_is_persistent(stream));</span>
<span class='curline'><a href='../S/867.html#L2060'>sslsock</a>          2060 ext/openssl/xp_ssl.c 		pefree(sslsock-&gt;sni_certs, php_stream_is_persistent(stream));</span>
<span class='curline'><a href='../S/867.html#L2061'>sslsock</a>          2061 ext/openssl/xp_ssl.c 		sslsock-&gt;sni_certs = NULL;</span>
<span class='curline'><a href='../S/867.html#L2064'>sslsock</a>          2064 ext/openssl/xp_ssl.c 	if (sslsock-&gt;url_name) {</span>
<span class='curline'><a href='../S/867.html#L2065'>sslsock</a>          2065 ext/openssl/xp_ssl.c 		pefree(sslsock-&gt;url_name, php_stream_is_persistent(stream));</span>
<span class='curline'><a href='../S/867.html#L2068'>sslsock</a>          2068 ext/openssl/xp_ssl.c 	if (sslsock-&gt;reneg) {</span>
<span class='curline'><a href='../S/867.html#L2069'>sslsock</a>          2069 ext/openssl/xp_ssl.c 		pefree(sslsock-&gt;reneg, php_stream_is_persistent(stream));</span>
<span class='curline'><a href='../S/867.html#L2072'>sslsock</a>          2072 ext/openssl/xp_ssl.c 	pefree(sslsock, php_stream_is_persistent(stream));</span>
<span class='curline'><a href='../S/867.html#L2156'>sslsock</a>          2156 ext/openssl/xp_ssl.c 	php_openssl_netstream_data_t *sslsock = (php_openssl_netstream_data_t*)stream-&gt;abstract;</span>
<span class='curline'><a href='../S/867.html#L2168'>sslsock</a>          2168 ext/openssl/xp_ssl.c 					if (sslsock-&gt;s.timeout.tv_sec == -1) {</span>
<span class='curline'><a href='../S/867.html#L2172'>sslsock</a>          2172 ext/openssl/xp_ssl.c 						tv = sslsock-&gt;connect_timeout;</span>
<span class='curline'><a href='../S/867.html#L2179'>sslsock</a>          2179 ext/openssl/xp_ssl.c 				if (sslsock-&gt;s.socket == -1) {</span>
<span class='curline'><a href='../S/867.html#L2181'>sslsock</a>          2181 ext/openssl/xp_ssl.c 				} else if (php_pollfd_for(sslsock-&gt;s.socket, PHP_POLLREADABLE|POLLPRI, &amp;tv) &gt; 0) {</span>
<span class='curline'><a href='../S/867.html#L2182'>sslsock</a>          2182 ext/openssl/xp_ssl.c 					if (sslsock-&gt;ssl_active) {</span>
<span class='curline'><a href='../S/867.html#L2186'>sslsock</a>          2186 ext/openssl/xp_ssl.c 							n = SSL_peek(sslsock-&gt;ssl_handle, &amp;buf, sizeof(buf));</span>
<span class='curline'><a href='../S/867.html#L2188'>sslsock</a>          2188 ext/openssl/xp_ssl.c 								int err = SSL_get_error(sslsock-&gt;ssl_handle, n);</span>
<span class='curline'><a href='../S/867.html#L2207'>sslsock</a>          2207 ext/openssl/xp_ssl.c 					} else if (0 == recv(sslsock-&gt;s.socket, &amp;buf, sizeof(buf), MSG_PEEK) &amp;&amp; php_socket_errno() != EAGAIN) {</span>
<span class='curline'><a href='../S/867.html#L2219'>sslsock</a>          2219 ext/openssl/xp_ssl.c 					cparam-&gt;outputs.returncode = php_openssl_setup_crypto(stream, sslsock, cparam TSRMLS_CC);</span>
<span class='curline'><a href='../S/867.html#L2223'>sslsock</a>          2223 ext/openssl/xp_ssl.c 					cparam-&gt;outputs.returncode = php_openssl_enable_crypto(stream, sslsock, cparam TSRMLS_CC);</span>
<span class='curline'><a href='../S/867.html#L2242'>sslsock</a>          2242 ext/openssl/xp_ssl.c 					if ((sslsock-&gt;enable_on_connect) &amp;&amp;</span>
<span class='curline'><a href='../S/867.html#L2247'>sslsock</a>          2247 ext/openssl/xp_ssl.c 						if (php_stream_xport_crypto_setup(stream, sslsock-&gt;method, NULL TSRMLS_CC) &lt; 0 ||</span>
<span class='curline'><a href='../S/867.html#L2258'>sslsock</a>          2258 ext/openssl/xp_ssl.c 					xparam-&gt;outputs.returncode = php_openssl_tcp_sockop_accept(stream, sslsock, xparam STREAMS_CC TSRMLS_CC);</span>
<span class='curline'><a href='../S/867.html#L2274'>sslsock</a>          2274 ext/openssl/xp_ssl.c 	php_openssl_netstream_data_t *sslsock = (php_openssl_netstream_data_t*)stream-&gt;abstract;</span>
<span class='curline'><a href='../S/867.html#L2278'>sslsock</a>          2278 ext/openssl/xp_ssl.c 			if (sslsock-&gt;ssl_active) {</span>
<span class='curline'><a href='../S/867.html#L2282'>sslsock</a>          2282 ext/openssl/xp_ssl.c 				*ret = fdopen(sslsock-&gt;s.socket, stream-&gt;mode);</span>
<span class='curline'><a href='../S/867.html#L2294'>sslsock</a>          2294 ext/openssl/xp_ssl.c 					&amp;&amp; sslsock-&gt;ssl_active</span>
<span class='curline'><a href='../S/867.html#L2295'>sslsock</a>          2295 ext/openssl/xp_ssl.c 					&amp;&amp; (pending = (size_t)SSL_pending(sslsock-&gt;ssl_handle)) &gt; 0) {</span>
<span class='curline'><a href='../S/867.html#L2301'>sslsock</a>          2301 ext/openssl/xp_ssl.c 				*(php_socket_t *)ret = sslsock-&gt;s.socket;</span>
<span class='curline'><a href='../S/867.html#L2307'>sslsock</a>          2307 ext/openssl/xp_ssl.c 			if (sslsock-&gt;ssl_active) {</span>
<span class='curline'><a href='../S/867.html#L2311'>sslsock</a>          2311 ext/openssl/xp_ssl.c 				*(php_socket_t *)ret = sslsock-&gt;s.socket;</span>
<span class='curline'><a href='../S/867.html#L2384'>sslsock</a>          2384 ext/openssl/xp_ssl.c 	php_openssl_netstream_data_t *sslsock = NULL;</span>
<span class='curline'><a href='../S/867.html#L2386'>sslsock</a>          2386 ext/openssl/xp_ssl.c 	sslsock = pemalloc(sizeof(php_openssl_netstream_data_t), persistent_id ? 1 : 0);</span>
<span class='curline'><a href='../S/867.html#L2387'>sslsock</a>          2387 ext/openssl/xp_ssl.c 	memset(sslsock, 0, sizeof(*sslsock));</span>
<span class='curline'><a href='../S/867.html#L2389'>sslsock</a>          2389 ext/openssl/xp_ssl.c 	sslsock-&gt;s.is_blocked = 1;</span>
<span class='curline'><a href='../S/867.html#L2391'>sslsock</a>          2391 ext/openssl/xp_ssl.c 	sslsock-&gt;s.timeout.tv_sec = FG(default_socket_timeout);</span>
<span class='curline'><a href='../S/867.html#L2392'>sslsock</a>          2392 ext/openssl/xp_ssl.c 	sslsock-&gt;s.timeout.tv_usec = 0;</span>
<span class='curline'><a href='../S/867.html#L2395'>sslsock</a>          2395 ext/openssl/xp_ssl.c 	sslsock-&gt;connect_timeout.tv_sec = timeout-&gt;tv_sec;</span>
<span class='curline'><a href='../S/867.html#L2396'>sslsock</a>          2396 ext/openssl/xp_ssl.c 	sslsock-&gt;connect_timeout.tv_usec = timeout-&gt;tv_usec;</span>
<span class='curline'><a href='../S/867.html#L2400'>sslsock</a>          2400 ext/openssl/xp_ssl.c 	sslsock-&gt;s.socket = -1;</span>
<span class='curline'><a href='../S/867.html#L2403'>sslsock</a>          2403 ext/openssl/xp_ssl.c 	sslsock-&gt;ctx = NULL;	</span>
<span class='curline'><a href='../S/867.html#L2405'>sslsock</a>          2405 ext/openssl/xp_ssl.c 	stream = php_stream_alloc_rel(&amp;php_openssl_socket_ops, sslsock, persistent_id, "r+");</span>
<span class='curline'><a href='../S/867.html#L2408'>sslsock</a>          2408 ext/openssl/xp_ssl.c 		pefree(sslsock, persistent_id ? 1 : 0);</span>
<span class='curline'><a href='../S/867.html#L2413'>sslsock</a>          2413 ext/openssl/xp_ssl.c 		sslsock-&gt;enable_on_connect = 1;</span>
<span class='curline'><a href='../S/867.html#L2414'>sslsock</a>          2414 ext/openssl/xp_ssl.c 		sslsock-&gt;method = get_crypto_method(context, STREAM_CRYPTO_METHOD_ANY_CLIENT);</span>
<span class='curline'><a href='../S/867.html#L2420'>sslsock</a>          2420 ext/openssl/xp_ssl.c 		sslsock-&gt;enable_on_connect = 1;</span>
<span class='curline'><a href='../S/867.html#L2421'>sslsock</a>          2421 ext/openssl/xp_ssl.c 		sslsock-&gt;method = STREAM_CRYPTO_METHOD_SSLv2_CLIENT;</span>
<span class='curline'><a href='../S/867.html#L2428'>sslsock</a>          2428 ext/openssl/xp_ssl.c 		sslsock-&gt;enable_on_connect = 1;</span>
<span class='curline'><a href='../S/867.html#L2429'>sslsock</a>          2429 ext/openssl/xp_ssl.c 		sslsock-&gt;method = STREAM_CRYPTO_METHOD_SSLv3_CLIENT;</span>
<span class='curline'><a href='../S/867.html#L2432'>sslsock</a>          2432 ext/openssl/xp_ssl.c 		sslsock-&gt;enable_on_connect = 1;</span>
<span class='curline'><a href='../S/867.html#L2433'>sslsock</a>          2433 ext/openssl/xp_ssl.c 		sslsock-&gt;method = get_crypto_method(context, STREAM_CRYPTO_METHOD_TLS_CLIENT);</span>
<span class='curline'><a href='../S/867.html#L2435'>sslsock</a>          2435 ext/openssl/xp_ssl.c 		sslsock-&gt;enable_on_connect = 1;</span>
<span class='curline'><a href='../S/867.html#L2436'>sslsock</a>          2436 ext/openssl/xp_ssl.c 		sslsock-&gt;method = STREAM_CRYPTO_METHOD_TLSv1_0_CLIENT;</span>
<span class='curline'><a href='../S/867.html#L2439'>sslsock</a>          2439 ext/openssl/xp_ssl.c 		sslsock-&gt;enable_on_connect = 1;</span>
<span class='curline'><a href='../S/867.html#L2440'>sslsock</a>          2440 ext/openssl/xp_ssl.c 		sslsock-&gt;method = STREAM_CRYPTO_METHOD_TLSv1_1_CLIENT;</span>
<span class='curline'><a href='../S/867.html#L2447'>sslsock</a>          2447 ext/openssl/xp_ssl.c 		sslsock-&gt;enable_on_connect = 1;</span>
<span class='curline'><a href='../S/867.html#L2448'>sslsock</a>          2448 ext/openssl/xp_ssl.c 		sslsock-&gt;method = STREAM_CRYPTO_METHOD_TLSv1_2_CLIENT;</span>
<span class='curline'><a href='../S/867.html#L2455'>sslsock</a>          2455 ext/openssl/xp_ssl.c 	sslsock-&gt;url_name = get_url_name(resourcename, resourcenamelen, !!persistent_id TSRMLS_CC);</span>
</pre>
</body>
</html>
